global
  log stdout local0
  log stdout local1 notice
  chroot /var/lib/haproxy
  stats socket /run/haproxy/admin.sock mode 660 level admin
  stats timeout 30s
  user haproxy
  group haproxy
  daemon
  tune.ssl.default-dh-param 2048
  tune.maxconn 4096
  tune.bufsize 65536
  tune.ssl.ciphers HIGH:!aNULL:!MD5
  tune.ssl.options default-server-options
  timeout tunnel 3600s
  http-check expect string false

defaults
  log  global
  mode http
  option httplog
  option dontlognull
  timeout connect 5000
  timeout client 50000
  timeout server 50000
  timeout http-request 10s
  timeout http-keep-alive 10s
  compression algo gzip
  compression type text/html text/plain text/css text/javascript application/javascript application/json

# Ethereum Stats
listen stats
  bind *:8404
  mode http
  stats enable
  stats uri /stats
  stats refresh 30s
  stats show-legends
  stats show-node
  stats admin if TRUE

# ============ ETHEREUM ============
frontend ethereum_http
  bind *:8080
  mode http
  option httpchk POST / HTTP/1.1\r\nHost:\ ethereum-node\r\nContent-Type:\ application/json\r\n\r\n{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}
  option forwardfor
  default_backend ethereum_http_backend
  timeout client 30000

frontend ethereum_ws
  bind *:8180
  mode http
  option httpchk POST / HTTP/1.1\r\nHost:\ ethereum-node\r\nContent-Type:\ application/json\r\n\r\n{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}
  default_backend ethereum_ws_backend
  timeout client 3600s

backend ethereum_http_backend
  balance leastconn
  mode http
  option httpchk POST / HTTP/1.1\r\nHost:\ ethereum-node\r\nContent-Type:\ application/json\r\n\r\n{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}
  http-check expect string false
  timeout connect 5000
  timeout server 50000
  server ethereum-node ethereum-node:8545 check inter 10s fall 2 rise 3 weight 10

# ============ POLYGON ============
frontend polygon_http
  bind *:8081
  mode http
  option forwardfor
  default_backend polygon_http_backend
  timeout client 30000

frontend polygon_ws
  bind *:8181
  mode http
  default_backend polygon_ws_backend
  timeout client 3600s

backend polygon_http_backend
  balance leastconn
  mode http
  option httpchk POST / HTTP/1.1\r\nHost:\ polygon-bor\r\nContent-Type:\ application/json\r\n\r\n{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}
  http-check expect string false
  timeout connect 5000
  timeout server 50000
  server polygon-bor polygon-bor:8545 check inter 10s fall 2 rise 3 weight 10

backend polygon_ws_backend
  balance leastconn
  mode http
  timeout connect 5000
  timeout server 3600s
  server polygon-bor polygon-bor:8546 check inter 10s fall 2 rise 3 weight 10

# ============ ARBITRUM ============
frontend arbitrum_http
  bind *:8082
  mode http
  option forwardfor
  default_backend arbitrum_http_backend
  timeout client 30000

frontend arbitrum_ws
  bind *:8182
  mode http
  default_backend arbitrum_ws_backend
  timeout client 3600s

backend arbitrum_http_backend
  balance leastconn
  mode http
  option httpchk POST / HTTP/1.1\r\nHost:\ arbitrum-node\r\nContent-Type:\ application/json\r\n\r\n{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}
  http-check expect string false
  timeout connect 5000
  timeout server 50000
  server arbitrum-node arbitrum-node:8545 check inter 10s fall 2 rise 3 weight 10

backend arbitrum_ws_backend
  balance leastconn
  mode http
  timeout connect 5000
  timeout server 3600s
  server arbitrum-node arbitrum-node:8546 check inter 10s fall 2 rise 3 weight 10

# ============ BSC ============
frontend bsc_http
  bind *:8083
  mode http
  option forwardfor
  default_backend bsc_http_backend
  timeout client 30000

frontend bsc_ws
  bind *:8183
  mode http
  default_backend bsc_ws_backend
  timeout client 3600s

backend bsc_http_backend
  balance leastconn
  mode http
  option httpchk POST / HTTP/1.1\r\nHost:\ bsc-node\r\nContent-Type:\ application/json\r\n\r\n{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}
  http-check expect string false
  timeout connect 5000
  timeout server 50000
  server bsc-node bsc-node:8545 check inter 10s fall 2 rise 3 weight 10

backend bsc_ws_backend
  balance leastconn
  mode http
  timeout connect 5000
  timeout server 3600s
  server bsc-node bsc-node:8546 check inter 10s fall 2 rise 3 weight 10

# ============ AVALANCHE ============
frontend avalanche_http
  bind *:8084
  mode http
  option forwardfor
  default_backend avalanche_http_backend
  timeout client 30000

frontend avalanche_ws
  bind *:8184
  mode http
  default_backend avalanche_ws_backend
  timeout client 3600s

backend avalanche_http_backend
  balance leastconn
  mode http
  option httpchk GET /ext/health HTTP/1.1\r\nHost:\ avalanche-node
  http-check expect status 200
  timeout connect 5000
  timeout server 50000
  server avalanche-node avalanche-node:9650 check inter 10s fall 2 rise 3 weight 10

backend avalanche_ws_backend
  balance leastconn
  mode http
  timeout connect 5000
  timeout server 3600s
  server avalanche-node avalanche-node:9650 check inter 10s fall 2 rise 3 weight 10

# ============ BASE ============
frontend base_http
  bind *:8085
  mode http
  option forwardfor
  default_backend base_http_backend
  timeout client 30000

frontend base_ws
  bind *:8185
  mode http
  default_backend base_ws_backend
  timeout client 3600s

backend base_http_backend
  balance leastconn
  mode http
  option httpchk POST / HTTP/1.1\r\nHost:\ base-node\r\nContent-Type:\ application/json\r\n\r\n{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}
  http-check expect string false
  timeout connect 5000
  timeout server 50000
  server base-node base-node:8545 check inter 10s fall 2 rise 3 weight 10

backend base_ws_backend
  balance leastconn
  mode http
  timeout connect 5000
  timeout server 3600s
  server base-node base-node:8546 check inter 10s fall 2 rise 3 weight 10
